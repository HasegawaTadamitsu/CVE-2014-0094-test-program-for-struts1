
# はじめに

CVE-2014-0094 のstruts1の影響についてまとめる。
特に断りがない限り、各バージョンは、java 1.7.0_02,struts 1.3.10,
apache-tomcat-6.0.39、FreeBSD 8.2 で確認を行った。

なるべく専門用語を使わず、語弊があるかもしれないが、わかりやすい言葉で
記載した。



# 背景

改めて説明するまでもなく、CVE-2014-0094は、とても大きな問題を抱えている。

    http://www.nta.go.jp/sonota/sonota/osirase/service.htm

「e-Taxソフト（WEB版）」、「確定申告書等作成コーナー」、「NISA（日本版ISA）コー\ナー」　サービス停止のお知らせ（重要）平成26年4月25日
によると、国税庁のweb service がstruts1を使用しており、
発見されたその日のうちにサービスを停止している。

被害を最小限に食いとどめるため、早急な停止をおこなったと思われる。

少なくとも上の環境でシステムが構築された場合、
URLにアクセスするだけで、
サービスの停止、任意のファイルの漏洩を
確認した。

URLにアクセスするだけでということで、匿名のメールアドレスで、
URLの書かれたメールをMLに出すだけで、犯人の特定が難しく、
簡単にサービス停止を行うことができる。



# まず行うこと　どのような攻撃か可能か調査する。


この問題は、システムが保持している設定値を一部書換え可能であることに起因する。
何の設定値が書換え可能か調査する必要がある。
その値によって、どのような攻撃が可能か判断する。

この設定値は、Servletコンテナによって異っている。
tomcat6では任意のコードの実行はおそらく不可能と思われるが、
tomcat8では任意の実行が可能である。
他、jetty,WebSphere Application Serverなど、使用する環境によって、
どのような設定値が確認する必要がある。

tomcat6の場合、23個この設定変更が可能とされており、
    class.classLoader.resources.dirContext.docBase
を変更した場合、通常のシステム可動が不可能になり、
また、JSPを表示する代わりに、サーバ上のファイルを指定することで、
任意のファイルが取得可能（漏洩）となる。

tomcat8の場合、任意のコードが実行可能だが、
これはtomcat6に比べ設定できる値が増えているからである。
その設定値が使用しているServertコンテナに存在しなければ今のところ
問題は少ないと考えられる。



# 攻撃有無を確認する。


今回の設定値変更は、URLとして、その文字列を含ませる他に、
通常のリクエストの隠し項目としても可能であり、
また、cookieにその値を含ませても可能とされている。

アクセスログからでは、隠し項目に設定した場合のわからない。

よく日曜日深夜に再起動を行うケースがあるが、
それより少し前に、docBaseの書換え、および、ファイル取得を行い、
その後、再起動がシステムにかかるため、
システム管理者的には、異常に気が付きにくい。
その時間帯を狙って、ステータス404,500など多発していたら、
おそらく何らかのファイルが漏洩した可能性が高いかもしれない。









